@model IEnumerable<PedidoResponseDTO>

@{
    ViewData["Title"] = "Todos Pedidos";

    if (TempData["SucessoGerarPagamento"] != null){
        <div class="alert alert-success" role="alert">
            @TempData["SucessoGerarPagamento"]
        </div>
    }
}

<table class="table">
    <thead>
        <tr>
            <th scope="col">#</th>
            <th scope="col">QTD. ITENS</th>
            <th scope="col">VALOR</th>
            <th scope="col">MESA</th>
            <th scope="col">AÇÕES</th>
        </tr>
    </thead>
    <tbody id="tbody-pedidos">
        @foreach(var pedido in Model){
            <tr>
                <th scope="row">@pedido.Id</th>
                <td>@pedido.Itens.Count()</td>
                <td>R$ @pedido.ValorTotal.ToString("F2")</td>
                <td>@pedido.Mesa.Numero</td>
                <td>
                    <a asp-area="" asp-controller="Pedido" asp-action="DetalhesPedido" asp-route-pedidoId="@pedido.Id"><i class="bi bi-info-circle"></i></a>
                    <a asp-area="" asp-controller="Caixa" asp-action="Pagamento" asp-route-pedidoId="@pedido.Id"><i class="bi bi-currency-dollar"></i></a>
                </td>
            </tr>
        }
    </tbody>
</table> 


<audio id="pedidoNovoSound" preload="auto">
    <source src="~/sounds/pedido-novo.mp3" type="audio/mpeg">
</audio>


<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
<script src="~/js/adicionarPedidoFinalizadoTabela.js"></script>
<script src="~/js/tocarSomPedidoNovo.js"></script>


<!--Script SignalR-->
<script>
    const token = document.cookie
    .split('; ')
    .find(row => row.startsWith('access_token='))
    ?.split('=')[1];

    const connection = new signalR.HubConnectionBuilder()
        .withUrl("https://localhost:7071/pedidoHub", {
            accessTokenFactory: () => {
                return '@Context.Session.GetString("JWToken")';
            }
        })
        .withAutomaticReconnect()
        .build();

    connection.start()
        .then(() => console.log("Conectado ao SignalR Hub"))
        .catch(err => console.error(err.toString()));

    connection.on("NovoPedidoFinalizado", function (pedido) {
        console.log("Novo pedido finalizado recebido:", pedido);
        adicionarPedidoNaTela(pedido);
        atualizarTotalPedidos();
        tocarSomNovoPedido();
    });
</script>

<!--Scrip tocar som-->
<script>
    let audioLiberado = false;

    document.addEventListener('click', () => {
        if(!audioLiberado){
            const audio = document.getElementById('pedidoNovoSound');
            audio.play().then(() => {
                audio.pause();
                audio.currentTime = 0;
                audioLiberado = true;
            })
        }
    });
</script>